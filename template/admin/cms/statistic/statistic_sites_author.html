<!--{php168}-->
<!--{template $this_module header admin}-->
<style type="text/css">
.formtable .title{color:#2a2a2a;background: #e8ebf3;}
.formtable td a.over{color:red};
</style>
<div class="mainbox mainborder">
	<div class="section">
		<table width="100%" border="0"  class="mainbox">
			<tr>
				<td>
					<ul class="boxmenu">
						<li class="btn-color1"><a href="$this_router-statistic_sites_content"><i class="icon icon-ico20"></i>子站各站点内容统计</a></li>
						<li class="btn-color2"><a href="$this_router-statistic_sites_push"><i class="icon icon-ico20"></i>子站推送数据</a></li>
						<li class="btn-color3"><a href="$this_router-statistic_sites_author"><i class="icon icon-ico20"></i>子站作者内容统计</a></li>
						<li class="btn-color5"><a href="{$core.admin_controller}/sites-index?frame=/sites-main" target="_blank"><i class="icon icon-ico20"></i>子站导出标题excel数据</a></li>
					</ul>
				</td>
			</tr>
		</table>
		<table class="columntable formtable" width="100%" border="0" cellspacing="3">
		<tr class="title fix_head">
			<td class="title" colspan="2">统计</td>
		</tr>
		<tr><td height="50" align="center">
		<form id="form1" method="post">		
		<!--{if !empty($uid)}-->
		相关人员：<b>{$username} </b>
		<!--{/if}-->
		站点：<select id="site" name="site" onchange="get_data(1)"><option value="" {if empty($site)}selected{/if}>全部</option>
			<!--{foreach $all_sites $vsite}-->
			<option value="{$vsite[alias]}" {if $vsite['alias']==$site} selected{/if}>{$vsite['sitename']}</option>
			<!--{/foreach}-->
			</select> 
		年份：<select id="year" name="year"  onchange="get_data(1)"><option value="0" selected>全部</option>
			<!--{foreach $years $year}-->
			<option value="{$year}" {if date('Y')==$year} selected{/if}>{$year}</option>
			<!--{/foreach}-->
			</select> 
		月份：<select id="month" name="month"  onchange="get_data(1)"><option value="0" selected>全部</option>
				<!--{foreach $months $month}-->
				<option value="{$month}">{$month}</option>
				<!--{/foreach}-->
			</select> 
		模型：<select id="model" name="model" onchange="get_data(1)"><option value="0" selected>全部</option>
			<!--{foreach $models $model}-->
			<option value="{$model['name']}">{$model['alias']}</option><
			<!--{/foreach}-->
			</select>
		每页条数：<select id="page_size" name="page_size" onchange="get_data(1)">
					<option value="10">10</option>
					<option value="20" selected>20</option>
					<option value="30">30</option>
					<option value="50">50</option>
			</select>
		<input type="hidden" name="uid" id="uid" value="{if !empty($uid)}{$uid}{/if}"/>
		<input type="hidden" name="act" id="act" value="query"/>
		<input type="button" value="导出Excel" class="submit_btn" onclick="download()"/>
		<!--{if empty($uid)}--> <a href="javascript:;" class="stabtn" style="color:#fff;" onclick="statistic()">重新统计</a><!--{/if}-->&nbsp;统计时间：<span id="statis_time">2012-05-01 </span>
		</form>
		</td>
		</tr>
		</table>
	</div>
</div>
<div class="mainbox mainborder">
	<div class="section">
		<table width="100%">
			<tr>
				<td width="50%" valign="top">
					<table  class="columntable formtable hover_table click_changeable" align="center" style="text-align:center">
					<tr><td width="100" class="title">排名</td><td width="100" class="title">作者</td><td width="100" class="title">发稿量</td></tr>
					<tbody id="data_list">
								
					</tbody>
					</table>
					<table width="100%" class="columntable formtable">
						<tr>
							<td align="center" id="pages" class="pages"></td>
						</tr>
					</table>
				</td>
				<td width="50%" valign="top">
					<div class="section" style="margin-top:0;background:#fff;padding:30px;">
						<div id="myChart_scatter" style="height:400px;margin-bottom:10px;"></div>
					</div>
				</td>
			</tr>
		</table>
	</div>
</div>
<script type="text/javascript">
$(".headerbtn_list li").removeClass();
$(".headerbtn_list li:nth-child(2)").addClass("active");

var CATEGORY_JSON = $json[json];
var CATEGORY_PATH = $json[path];

function _toggle(span){
	var id = $(span).parent().parent().attr('id').replace(/[^0-9]/g, '');
	var path = CATEGORY_PATH[id].join('_');
	
	var on = $('#category_'+ id).attr('title') == 0;
	
	var keep_close = [];
	$('tr[path^=path_'+ path +'_]').each(function(){
		if(on){
			
			if($(this).show().attr('title') == 1 && $(this).attr('sub')){
				keep_close.push(this.id.replace(/[^0-9]/g, ''));
				$(this).attr('title', 0);
			}else{
				$(this).attr('title', 1);
			}
			
		}else{
			
			if($(this).hide().attr('title') == 0 && $(this).attr('sub')){
				//keep close
				$(this).attr('title', 1);
			}else{
				$(this).attr('title', 0);
			}
			
		}
	});
	
	if(on){
		$(span).parent().parent().attr('title', 1);
		$(span).html('<img src="{$SKIN}/hide.gif" />');
	}else{
		$(span).parent().parent().attr('title', 0);
		$(span).html('<img src="{$SKIN}/show.gif" />');
	}
	
	for(var i = 0; i < keep_close.length; i++){
		$('tr[path^=path_'+ CATEGORY_PATH[keep_close[i]].join('_') +'_]').hide().find('span');
	}
	return false;
}

function get_data(page){
	$('#act').val('query');	
	var year=$('#year').val();
	var month=$('#month').val();
	var model=$('#model').val();
	ajaxing({});
	$.ajax({
		url:'{$this_url}',
		data: $('#form1').serialize() +'&page='+ (page === undefined ? 1 : page),
		dataType: 'json',
		type: 'POST',
		success: function(json){
			var msg = json.list;
			if(msg!=''){
				var shtml = '';
				var statis_time;
				var h=0;
				var list=1;
				var show_title = [];
				var show_post = [];
				for(var i in msg){
					show_title[i] = msg[i].author;
					show_post[i] = msg[i].num;
					h++;
					if(i==0){
						list = h;
					}else{
						if(msg[i-1].num != msg[i].num) list = h;
					}
					shtml +=  '<tr><td>'+list+'</td><td>'+msg[i].author+'</td><td>'+msg[i].num+'</td></tr>';
					statis_time=msg[i].timestamp;
				}
				$('#statis_time').html(statis_time);
				$('#data_list').html(shtml);
				$('#pages').html(json.pages);
				if(shtml == ''){
					ajaxing({action: 'hide'});
					p8_window.alert('暂无数据！');
					return false;
				}
				var myChart = echarts.init(document.getElementById('myChart_scatter'));
				myChart.clear();
				myChart.showLoading();
				option = {					
					title: {
						show: true,
						text: '分站作者发稿统计',
						left: 'center',
					},
					toolbox: {
						feature: {
							saveAsImage: {show: true}
						}
					},
					tooltip: {
						trigger: 'axis',					
					},
					legend: {				
						right: '10%',
						show:false,
					},
					grid: {
						left: '3%',
						right: '4%',
						bottom: '3%',
						containLabel: true
					},
					calculable: true,
					xAxis: {
						type: 'category',
						data: show_title,
					},
					yAxis: {
						name: '发稿量',
						axisLine: {
							lineStyle: {
								color: '#666'
							}
						},
						splitLine: {
							lineStyle: {
								color: '#ddd'
							}
						}
					},
					series: [{
						name: '发稿量',
						data: show_post,
						type: 'bar',								
						barWidth:'30%',	
						itemStyle: {
							normal: {color:'#3398DB'}
						},
						label: {position:'top',show:'true'},
					},					
				]
					
				};
				// 使用刚指定的配置项和数据显示图表。
				myChart.setOption(option);
				myChart.hideLoading();
				
			}else{
				$('#data_list').html('<tr><td colspan="3" align="center">没有相关数据</td></tr>');
				$('#pages').html('');
				var myChart = echarts.init(document.getElementById('myChart_scatter'));
				myChart.clear();
			}
			ajaxing({action: 'hide'});
		}
	});
}
function statistic(page){
	if($('#year').val()==0){
		p8_window.alert('请选择至少一个年份');
		return false
	}
	var d = new Date(); 
	$('#statis_time').html(d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate()+' '+d.getHours()+':'+d.getMinutes());
	$('#act').val('stat');
	ajaxing({});
	$.ajax({
		url:'{$this_url}',
		data: $('#form1').serialize() +'&page='+ (page === undefined ? 1 : page),
		dataType: 'json',
		type: 'POST',
		success: function(msg){
			if(msg)
				p8_window.alert('统计成功!');
			else
				p8_window.alert('统计失败!');
			get_data(1);
			ajaxing({action: 'hide'});
		}
	});
}
function aover(obj){
$('#__ a').removeClass('over');
$('#category_0 a').removeClass('over');
$(obj).addClass('over');
}

function download(style){
	
	$('#act').val('download');
	$('#form1').submit();

}
get_data(1);
</script>
<!--{template $core footer admin}-->
<!--{/php168}-->