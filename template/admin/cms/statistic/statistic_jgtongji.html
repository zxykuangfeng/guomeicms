<!--{php168}-->
<!--{template $this_module header admin}-->
<script type="text/javascript" src="{$RESOURCE}/js/rcalendar.js"></script>
<style type="text/css">
.formtable .title{color:#2a2a2a;background: #e8ebf3;}
.formtable td a.over{color:red};
</style>
<form action="$this_url" method="post">
<div class="mainbox mainborder">
	<div class="section">
		<table class="columntable formtable hover_table">
			<tr class="title fix_head">
				<td class="title">{$P8LANG['config']}</td>
			</tr>			
			<tr>
				<td align="center">
					选择组织架构:
					<!--{foreach $parents $n $p}-->
						<select onchange="if(this.value) window.location.href = '$this_url?parent='+ this.value">
							<option value="$p">请选择</option>
							<!--{foreach $list $k $v}-->
								<!--{if $v['parent'] == $p}-->
								<!--{php if(isset($parents[$n +1])) unset($list[$k]);}-->
								<option value="$v[id]"{if isset($parents[$n +1]) && $v['id'] == $parents[$n +1]} selected{/if}>$v[id]: $v[name]</option>
								<!--{/if}-->
							<!--{/foreach}-->
						</select>
					<!--{/foreach}-->					
					
					&nbsp;统计时间段：
						<input type="text" name="config[statistic_start_date]" class="txt" value="{if isset($config['statistic_start_date'])}$config[statistic_start_date]{/if}" autocomplete="off" onclick="rcalendar(this, 'full')" /> - 
						<input type="text" name="config[statistic_end_date]" class="txt" value="{if isset($config['statistic_end_date'])}$config[statistic_end_date]{/if}" autocomplete="off" onclick="rcalendar(this, 'full')" />
						<input type="hidden" name="act" value="config">
						<input type="submit" value="{$P8LANG['config']}" class="submit_btn"/>
						<a href="javascript:;" class="stabtn" style="text-indent:18px;color:#fff;" onclick="$('#form input[name=act]').val('fix');$('#form').get(0).submit();">重新统计</a>									
				</td>
			</tr>	
		</table>
	</div>
</div>
</form>
<form action="$this_url" method="post" id="form">
	<div class="mainbox mainborder">
		<div class="section">
			<table border="0" width="100%" cellpadding="0" cellspacing="0">
				<tr>
					<td>
						<table class="columntable formtable hover_table">
							<tr class="title fix_head">
								<td width="5%" class="title" align="center"><input type="checkbox" onclick="check_all(this, 'id[]');" /></td>
								<td width="3%" class="title" align="center">{$P8LANG['id']}</td>
								<td width="25%" class="title">{$P8LANG['dept_name']}</td>
								<td width="18%" class="title" align="center">{$P8LANG['dept_display_order']}</td>
								<td width="13%" class="title" align="center">{$P8LANG['item_count']}</td>
								<td width="13%" class="title" align="center">{$P8LANG['item_score']}</td>
								<td width="13%" class="title" align="center">{$P8LANG['item_count_sites']}</td>
								<td width="13%" class="title" align="center">{$P8LANG['item_score_sites']}</td>
							</tr>
							
							<!--{foreach $list $value}-->
							<tr>
								<td align="center"><input type="checkbox" name="id[]" value="$value[id]" /></td>
								<td align="center">{$value[id]}</td>
								<td><input type="text" name="name[$value[id]]" value="$value[name]" />								
								<a href="$this_url?parent={$value[id]}" style="float:right;margin-right:10px;">详情>></a>
								<!--{if $value['parent']}-->
								<a href="$this_url?parent={$parentid}" style="float:right;margin-right:10px;"><<返回上级</a>
								<!--{/if}-->
								</td>
								<td align="center"><input type="text" name="display_order[$value[id]]" size="5" value="$value[display_order]" /></td>
								<td align="center">$value[item_count]</td>
								<td align="center">$value[item_score]</td>
								<td align="center">$value[item_count_sites]</td>
								<td align="center">$value[item_score_sites]</td>
							</tr>
							<!--{/foreach}-->
							
							<tr id="add">
								<td></td>
								<td></td>
								<td><input type="text" name="post[name][]" value="" /></td>								
								<td align="center"><input type="text" name="post[display_order][]" size="5" value="" /></td>
								<td align="center"></td>
								<td align="center"></td>
								<td align="center"></td>
								<td align="center"></td>
							</tr>
							
							<tr>
								<td colspan="8">
									<input type="button" value="添加组织架构" onclick="$('#add').clone().insertBefore($(this).parent().parent()).find('input').val('');" />
								</td>
							</tr>
							<tr>
								<td colspan="8">
									<input type="submit" value="提交" class="edit_btn" />
									<input type="button" value="更新缓存" class="edit_btn" onclick="$('#form input[name=act]').val('cache');$('#form').get(0).submit();" />
									<input type="submit" value="删除" onclick="return confirm('$P8LANG[confirm_to_delete]');" class="edit_btn" />						
								</td>
							</tr>
						</table>
					</td>
				</tr>					
			</table>
			<input type="hidden" name="type" value="" />
			<input type="hidden" name="act" value="" />
			<input type="hidden" name="parent" value="$parent" />
		</div>
	</div>
</form>

<iframe src="about:blank" style="display: none;" name="poster"></iframe>

<script type="text/javascript">
function statistic(){
	p8_window.confirm('{$P8LANG['confirm_to_selected']}', function (r) {
		if(r){
			$('#form input[name=act]').val('fix');
			$('#form').submit();
		}else{
			return;
		}
	});
}
function delete_dept(obj){
	p8_window.confirm('{$P8LANG['confirm_to_delete']}', function (r) {
		if(r){
			$.ajax({
				url: '$this_url',
				type: 'POST',
				dataType: 'json',
				data: {act: 'delete', id: obj.id.replace(/[^0-9]/g, '')},
				cache: false,
				success: function(json){
					for(var i in json){
						$('#delete_'+ json[i]).parent().parent().remove();
					}
				}
			});
		}
	});
	
	return false;
}

$('form input[name^=name]').change(function(){
	
	$('#form').append('<input type="hidden" name="update[]" value="'+ this.name.replace(/[^0-9]/g, '') +'" />');
	$(this).css({border: '1px solid #ff0000'});
});

$('form input[name^=display_order]').change(function(){
	this.value = this.value.replace(/[^0-9]/g, '') || 0;
	if(this.value > 255) this.value = 255;
	if(this.value < 0) this.value = 0;
	
	$('#form').append('<input type="hidden" name="update[]" value="'+ this.name.replace(/[^0-9]/g, '') +'" />');
	$(this).css({border: '1px solid #ff0000'});
});

</script>

<!--{template $core footer admin}-->
<!--{/php168}-->