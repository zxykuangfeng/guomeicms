<!--{php168}-->
<!--{template $this_module header admin}-->
<style type="text/css">
.formtable .title{color:#2a2a2a;background: #e8ebf3;}
.formtable td a.over{color:red};
</style>
<div class="mainbox mainborder">
	<div class="section">
		<table width="100%" border="0"  class="mainbox">
			<tr>
				<td>
					<ul class="boxmenu">
						<li class="btn-color1"><a href="$this_router-statistic_sites_content"><i class="icon icon-ico20"></i>子站各站点内容统计</a></li>
						<li class="btn-color2"><a href="$this_router-statistic_sites_push"><i class="icon icon-ico20"></i>子站推送数据</a></li>
						<li class="btn-color3"><a href="$this_router-statistic_sites_author"><i class="icon icon-ico20"></i>子站作者内容统计</a></li>
						<li class="btn-color5"><a href="{$core.admin_controller}/sites-index?frame=/sites-main" target="_blank"><i class="icon icon-ico20"></i>子站导出标题excel数据</a></li>
					</ul>
				</td>
			</tr>
		</table>
		<table class="columntable formtable" width="100%" border="0" cellspacing="3">
		<tr class="title fix_head">
			<td class="title" colspan="2">统计</td>
		</tr>
		<tr><td height="50">
		<form id="form1" method="post" style="float:left;">

		年份：<select id="year" name="year"  onchange="get_data()"><option value="0" selected>全部</option>
			<!--{foreach $years $year}-->
			<option value="{$year}" {if date('Y')==$year} selected{/if}>{$year}</option>
			<!--{/foreach}-->
			</select> 
		月份：<select id="month" name="month"  onchange="get_data()"><option value="0" selected>全部</option>
				<!--{foreach $months $month}-->
				<option value="{$month}">{$month}</option>
				<!--{/foreach}-->
			</select> 

		<input type="hidden" name="cid" id="cid" value="0"/>
		<input type="hidden" name="uid" id="uid" value="{if !empty($uid)}{$uid}{/if}"/>
		<input type="hidden" name="act" id="act" value="query"/>
		<input type="button" value="导出Excel" class="submit_btn" onclick="download()"/>
		</form>
		<span style="float:left;margin-left:10px;"><!--{if empty($uid)}--><a href="javascript:;" class="stabtn" onclick="statistic()" style="color:#fff;">重新统计</a><!--{/if}-->&nbsp;统计时间：<span id="statis_time">2012-05-01 </span></span>
		</td>
		</tr>
	</table>
	</div>
</div>
<div class="mainbox mainborder">
	<div class="section">
		<table  class="columntable formtable hover_table click_changeable" align="center" style="text-align:center">
			<tr>
				<td width="10%" class="title">排名</td>
				<td width="30%" class="title">站点名称</td>
				<td width="20%" class="title">投稿量</td>
				<td width="20%" class="title">采用量</td>
				<td width="20%" class="title">优秀量</td>
			</tr>
			</tr>
			<tbody id="data_list"></tbody>
		</table>	
		<div style="margin-top:0;background:#fff;padding:30px;">
			<div id="myChart_scatter" style="height:400px;margin-bottom:10px;"></div>
		</div>			
	</div>
</div>
<script type="text/javascript">
$(".headerbtn_list li").removeClass();
$(".headerbtn_list li:nth-child(2)").addClass("active");

var SITES = {$sites};
function get_data(cid){
	$('#cid').val(cid);
	$('#act').val('query');
	
	var year=$('#year').val();
	var month=$('#month').val();
	var model=$('#model').val();
	ajaxing({});
	$.ajax({
		url:'{$this_url}',
		data: $('#form1').serialize(),
		dataType: 'json',
		type: 'POST',
		success: function(msg){
			if(msg!=''){
				var shtml = '';
				var statis_time;
                var hs = [];
                var h=0;
				var list=1;
				var show_title = [];
				var show_post = [];
				var show_verified = [];
				var show_score = [];
				var show_id = 0;
				for(var i in msg){
                    if(SITES[msg[i].site]==undefined)continue;
					show_title[show_id] = SITES[msg[i].site]['sitename'];
					show_post[show_id] = msg[i].post;
					show_verified[show_id] = msg[i].verified;
					show_score[show_id] = msg[i].score;
					show_id++;
					h++;
					if(i==0){
						list = h;
					}else{
						if(msg[i-1].post != msg[i].post) list = h;
					}
					shtml +=  '<tr><td>'+list+'</td><td>'+SITES[msg[i].site]['sitename']+'</td><td>'+msg[i].post+'</td><td>'+msg[i].verified+'</td><td>'+msg[i].score+'</td></tr>';
					statis_time=msg[i].timestamp;
                    hs.push(msg[i].site);
				}
               if(list != 1) list++;
                for(var k in SITES){
                    if(SITES[k]==undefined)continue;
                    if($.inArray(SITES[k]['alias'],hs)!=-1)continue;					
					shtml +=  '<tr><td>'+list+'</td><td>'+SITES[k]['sitename']+'</td><td>0</td><td>0</td><td>0</td></tr>';
				}
				$('#statis_time').html(statis_time);
				$('#data_list').html(shtml);
				if(shtml == ''){
					ajaxing({action: 'hide'});
					p8_window.alert('暂无数据！');
					return false;
				}
				var myChart = echarts.init(document.getElementById('myChart_scatter'));
				myChart.showLoading();
				option = {					
					title: {
						show: true,
						text: '分站推送统计',
						left: 'center',
					},
					toolbox: {
						feature: {
							saveAsImage: {show: true}
						}
					},
					tooltip: {
						trigger: 'axis',					
					},
					legend: {				
						right: '10%',			
					},
					grid: {
						left: '3%',
						right: '4%',
						bottom: '3%',
						containLabel: true
					},
					calculable: true,
					xAxis: {
						type: 'category',
						data: show_title,
					},
					yAxis: {
						name: '数量',
						axisLine: {
							lineStyle: {
								color: '#666'
							}
						},
						splitLine: {
							lineStyle: {
								color: '#ddd'
							}
						}
					},
					series: [{
						name: '投稿量',
						data: show_post,
						type: 'bar',								
						barWidth:'30%',	
						itemStyle: {
							normal: {color:'#3398DB'}
						},
						label: {position:'top',show:'true'},
					},
					{
						name: '采用量',
						data: show_verified,
						type:'bar',
						itemStyle: {
							normal: {color:'#00B050'}
						},	
						barWidth:'30%',
					},
					{
						name: '优秀量',
						data: show_score,
						type:'bar',
						itemStyle: {
							normal: {color:'#00B050'}
						},	
						barWidth:'30%',
					}
				]
					
				};
				// 使用刚指定的配置项和数据显示图表。
				myChart.setOption(option);
				myChart.hideLoading();
				
			}else{
				$('#data_list').html('<tr><td colspan="3" align="center">没有相关数据</td></tr>');
			}
			ajaxing({action: 'hide'});
		}
	});
}
function statistic(){
	if($('#year').val()==0){
		p8_window.alert('请选择至少一个年份');
		return false
	}
	var d = new Date(); 
	$('#statis_time').html(d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate()+' '+d.getHours()+':'+d.getMinutes());
	$('#act').val('stat');
	ajaxing({});
	$.ajax({
		url:'{$this_url}',
		data: $('#form1').serialize(),
		dataType: 'json',
		type: 'POST',
		success: function(msg){
			if(msg)
				p8_window.alert('统计成功!');
			else
				p8_window.alert('统计失败!');
			get_data();
			ajaxing({action: 'hide'});
		}
	});
}
function aover(obj){
$('#__ a').removeClass('over');
$('#category_0 a').removeClass('over');
$(obj).addClass('over');
}

function download(style){
	
	$('#act').val('download');
	$('#form1').submit();

}
get_data();
</script>
<!--{template $core footer admin}-->
<!--{/php168}-->