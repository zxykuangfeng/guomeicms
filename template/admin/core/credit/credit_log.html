<!--{php168}-->
<!--{template $this_module header admin}-->
<script type="text/javascript" src="{$RESOURCE}/js/rcalendar.js"></script>
<div class="mainbox mainborder">
	<div class="section">
		<table width="100%" border="0"  class="mainbox">
			<tr>
				<td>
					<ul class="boxmenu">
						<li class="btn-color1"><a href="$this_router-statistic_credit"><i class="icon icon-ico20"></i>绩效评分统计</a></li>
						<li class="btn-color2"><a href="$this_router-add"><i class="icon icon-ico20"></i>添加绩效类型</a></li>
						<li class="btn-color3"><a href="$this_router-list"><i class="icon icon-ico20"></i>绩效列表</a></li>
						<li class="btn-color5"><a href="$this_router-add_rule?{if !empty($system)}&system=$system{/if}{if !empty($module)}&module=$module{/if}{if !empty($postfix)}&postfix=$postfix{/if}"><i class="icon icon-ico45"></i>添加绩效规则</a></li>
						<li class="btn-color6"><a href="$this_router-list_rule"><i class="icon icon-ico20"></i>绩效规则列表</a></li>
						<li class="btn-color7"><a href="$this_router-credit_log"><i class="icon icon-ico20"></i>绩效规则记录</a></li>
						<li class="btn-color8"><a href="$this_router-cache"><i class="icon icon-ico43"></i>{$P8LANG['update_cache']}</a></li>
					</ul>
				</td>
			</tr>
		</table>
		<table class="columntable formtable">
			<tr class="title fix_head">
				<td class="title">{$P8LANG['search']}</td>
			</tr>
			<tr>
			<td class="headerbtn_list">
				<form action="$this_url" method="get" id="request" onsubmit="request_item(1);return false;">
					系统：<select id="system" class="txt" name="system">
						<option value="" selected>不限</option>
						<!--{foreach $systems $name $v}-->
						<option value="{$name}">{$v['alias']}</option>
						<!--{/foreach}-->
						</select>
					绩效：
					<select id="credit_id" class="txt" name="credit_id" onchange="show_credit(this.value)">
						<option value="0" selected>不限</option>
						<!--{foreach $credit_type $type $credit_name}-->
						<option value="{$type}" {if $type==$init_credit_type}selected{/if}>{$credit_name}</option>
						<!--{/foreach}-->
					</select>
					<span id="credit_level">
					评分类型：
					<select class="txt" name="credit_level">
						<option value="0" selected>不限</option>
						<!--{foreach $levels $level_type $v}-->
						<option value="{$level_type}">{$v}</option>
						<!--{/foreach}-->
					</select>
					</span>
					时间段：<input type="text" class="txt" id="start_date" name="start_date" value="{if isset($start_date)}$start_date{/if}" autocomplete="off" onclick="rcalendar(this,'full')" /> - 
					<input type="text" class="txt" id="end_date" name="end_date" value="{if isset($end_date)}$end_date{/if}" autocomplete="off" onclick="rcalendar(this,'full')" />
					<select onchange="$('#cond').attr('name', this.value);">
						<option value="username"{if !empty($username)} selected{/if}>按用户名</option>												
						<option value="setter"{if !empty($setter)} selected{/if}>按设置者</option>						
						<option value="name"{if !empty($name)} selected{/if}>按姓名</option>
					</select>
					<input type="text" class="txt" id="cond" size="15" {if !empty($keyword)} name="word" value="$keyword"{elseif !empty($id)}name="id" value="{implode(',', $id)}"{elseif !empty($username)}name="username" value="$username"{else} name="word"{/if} />
					<input type="submit" value="{$P8LANG['search']}" class="submit"/>
					<input type="button" value="{$P8LANG['refresh']}" class="refreshbtn" onclick="request_item(PAGE)" />					
				</form>				
			</td>
			</tr>	
		</table>
	</div>
</div>
<div class="mainbox mainborder">
	<div class="section">
		<form action="" method="POST">
		<table class="mainbox mainborder">
			<tr>
				<td>				
				<table class="columntable formtable hover_table">
				<tr class="title fix_head">
					<td width="5%" align="center" class="title">ID</td>
					<td width="8%" align="center" class="title">{$P8LANG['mcredit']['system']}</td>
					<td width="8%" align="center" class="title">{$P8LANG['mcredit']['module']}</td>
					<td width="5%" align="center" class="title">{$P8LANG['mcredit']['site']}</td>
					<td width="10%" align="center" class="title">{$P8LANG['mcredit']['uid']}</td>
					<td width="5%" align="center" class="title">{$P8LANG['mcredit']['infoid']}</td>
					<td width="5%" align="center" class="title">{$P8LANG['mcredit']['credit_id']}</td>
					<td width="5%" align="center" class="title">{$P8LANG['mcredit']['credit']}</td>
					<td width="5%" align="center" class="title">{$P8LANG['mcredit']['setter']}</td>
					<td width="12%" align="center" class="title">{$P8LANG['mcredit']['timestamp']}</td>
					<td width="*" align="center" class="title">{$P8LANG['mcredit']['reason']}</td>
					<td width="8%" align="center" class="title">{$P8LANG['operation']}</td>
				</tr>
				<tbody id="list">
					
				</tbody>				
				</table>
				<table width="100%" class="columntable formtable">
					<tr>
						<td align="center" id="pages" class="pages"></td>
					</tr>
				</table>
			</td>
			</tr>
		</table>		
		</form>
	</div>
</div>
<script type="text/javascript">
$(".first_level li").removeClass();
$(".first_level li:nth-child(3)").addClass("active");

function show_credit(selected_item){
	if(selected_item == '3')
		$('#credit_level').show();
	else
		$('#credit_level').hide();
}
function _delete_credit(obj){
	//if(!confirm('$P8LANG[confirm_to_delete]')) return false;
	p8_window.confirm('{$P8LANG['confirm_to_delete']}', function (r) {
		if(r){
			var id = $(obj).attr('id').replace(/[^0-9]/g, '');	
			$.ajax({
				url: '$this_router-delete_credit_log',
				type: 'POST',
				cache: false,
				data: {id: id},
				beforeSend: function(){
					ajaxing({});
				},
				success: function(status){
					ajaxing({action: 'hide'});
					
					if(status == 0) return false;
					
					$(obj).parent().parent().remove();
				}
			});
			return false;
		}else{
			return false;
		}
	});	
}
function request_item(page){
	
	$.ajax({
		url: '$this_url',
		data: $('#request').serialize() +'&page='+ (page === undefined ? 1 : page),
		dataType: 'json',
		cache: false,
		beforeSend: function(){
			ajaxing({});
		},
		success: function(json){
			PAGE = page;
			$('#list').empty();
			for(var i in json.list){
				_list_item(json.list[i]);
			}			
			$('#pages').html(json.pages);			
			ajaxing({action: 'hide'});			
			window.scrollTo(0, 0);						
			init_tr($('#form'));			
		}
	});
}
function _list_item(json){
	var url = '';
	var props = ['system', 'module','username','name','url','site', 'iid', 'reason', 'credit_id', 'setter', 'credit'];
	
	for(var i = 0; i < props.length; i++){
		if(json[props[i]] === undefined) json[props[i]] = '';
	}
	
	if(json.url){
		url = '<a href="'+json.url+'" target="_blank">{$P8LANG[view]}</a>';
	}
	
	var tr = '<tr class="list_item">'+
		'<td align="center">'+ json.id +'</td>'+
		'<td align="center">'+ json.system +'</td>'+
		'<td align="center">'+ json.module +'</td>'+
		'<td align="center">'+ json.site +'</td>'+
		'<td align="center"><a href="{$core.admin_controller}/core/member-view?id='+ json.uid +'" target="_blank">'+ (json.name?json.name:'') +' '+ (json.username?json.username:'') +'</a></td>'+
		'<td align="center">'+ url +'</td>'+
		'<td align="center">'+ json.credit_id +'</td>'+
		'<td align="center">'+ json.credit +'</td>'+
		'<td align="center">'+ json.setter +'</td>'+
		'<td align="center">'+ date('Y-m-d H:i', json.timestamp) +'</td>'+
		'<td align="center">'+ json.reason +'</td>'+
		'<td align="center">'+ 
			'{if $allow_delete}<a href="{$this_router}-delete_credit_log?id='+json.id+'" id="credit_'+json.id+'" onclick="return _delete_credit(this)">{$P8LANG[delete]}</a>{/if}'+
		'</td>'+
	'</tr>';
	$('#list').append($(tr));
}
$(function(){
	$('#credit_level').hide();
	request_item(1);
});
</script>

<!--{template $core footer admin}-->
<!--{/php168}-->