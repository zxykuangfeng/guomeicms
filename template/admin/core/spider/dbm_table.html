<!--{php168}-->
<!--{template $this_module header admin}-->
<!--{template $this_module dbm_menu admin}-->
<form action="$this_url" method="post" id="request">
	<div class="mainbox mainborder">
		<div class="section">
			<table border="0" width="100%" cellpadding="0" cellspacing="0">
				<tr><td>
					<table class="columntable formtable hover_table">
						<tr class="title fix_head">
							<td colspan="2" class="title">MySQL数据库采集配置</td>
						</tr>																		
						<tr>
							<td class="tdL">会员数据表（供步骤3.导入会员使用）</td>
							<td class="tdR">
								<select name="db_member">
									<option value="">请选择数据表</option>
									<!--{foreach $tables $table}-->
									<option value="{$table['Name']}" {if $config['db_member'] == $table['Name']}selected{/if}>表名：{$table['Name']} 行数：{$table['Rows']}</option>
									<!--{/foreach}-->
								</select>
								<a href="javascript:;" style="color:blue;" onclick="if($('select[name=db_member]').val()) window.open('{$this_router}-dbm_struct?name='+$('select[name=db_member]').val());">查看数据结构</a>
							</td>							
						</tr>
						<tr>
							<td class="tdL">栏目分类数据表（供步骤4.导入栏目分类使用）</td>
							<td class="tdR">
								<select name="db_category">
									<option value="">请选择数据表</option>
									<!--{foreach $tables $table}-->
									<option value="{$table['Name']}" {if $config['db_category'] == $table['Name']}selected{/if}>表名：{$table['Name']} 行数：{$table['Rows']}</option>
									<!--{/foreach}-->
								</select>
								<a href="javascript:;" onclick="if($('select[name=db_category]').val()) window.open('{$this_router}-dbm_struct?name='+$('select[name=db_category]').val());">查看数据结构</a>
							</td>							
						</tr>
						<tr>
							<td class="tdL">内容数据表（按重要程度依次选择）<br>（与“自定义内容数据表SQL”二选一）<br/>供步骤5.导入内容使用</td>
							<td class="tdR">								
								<table width="90%" border="0" cellspacing="0" cellpadding="0" class="">
									<tr>
										<td width="16">数据表类型</td>
										<td width="28%" align="center">主表0（必选）</td>
										<td width="28%" align="center">副表1（任选）</td>
										<td width="28%" align="center">副表2（任选）</td>									
									</tr>
									<tr>
										<td>数据表</td>
										<td>
											<select name="db_item_main" onchange="get_table_struct(this.value,'db_item_main_field')">
												<option value="">请选择主表</option>
												<!--{foreach $tables $table}-->
												<option value="{$table['Name']}" {if $config['db_item_main'] == $table['Name']}selected{/if}>表名：{$table['Name']} 行数：{$table['Rows']}</option>
												<!--{/foreach}-->
											</select>
										</td>
										<td>
											<select name="db_item_main2" onchange="get_table_struct(this.value,'db_item_main2_field')">
												<option value="">请选择副表1</option>
												<!--{foreach $tables $table}-->
												<option value="{$table['Name']}" {if $config['db_item_main2'] == $table['Name']}selected{/if}>表名：{$table['Name']} 行数：{$table['Rows']}</option>
												<!--{/foreach}-->
											</select>
										</td>
										<td>
											<select name="db_item_main3" onchange="get_table_struct(this.value,'db_item_main3_field')">
												<option value="">请选择副表2</option>
												<!--{foreach $tables $table}-->
												<option value="{$table['Name']}" {if $config['db_item_main3'] == $table['Name']}selected{/if}>表名：{$table['Name']} 行数：{$table['Rows']}</option>
												<!--{/foreach}-->
											</select>
										</td>
									</tr>
									<tr>
										<td>字段</td>
										<td>
											<div style="height:400px;overflow-y:scroll;" id="db_item_main_field">
												<!--{if $db_item_main}-->
												<!--{foreach $db_item_main $field}-->
												<input type="checkbox" name="db_item_main_field[]" value="{$field['Field']}" {if in_array($field['Field'],$config['db_item_main_field'])}checked{/if} /> {$field['Field']}  {$field['Comment']}
												<input type="hidden" name="main_comment[{$field['Field']}]" value="{$field['Comment']}" /><br/>
												<!--{/foreach}-->
												<!--{else}-->
												请选择主表
												<!--{/if}-->											
											</div>
										</td>
										<td>
											<div style="height:400px;overflow-y:scroll;" id="db_item_main2_field">
												<!--{if $db_item_main2}-->
												<!--{foreach $db_item_main2 $field}-->
												<input type="checkbox" name="db_item_main2_field[]" value="{$field['Field']}" {if in_array($field['Field'],$config['db_item_main2_field'])}checked{/if} /> {$field['Field']}  {$field['Comment']}
												<input type="hidden" name="main2_comment[{$field['Field']}]" value="{$field['Comment']}" /><br/>
												<!--{/foreach}-->
												<!--{else}-->
												请选择副表1
												<!--{/if}-->
											</div>
										</td>
										<td>
											<div style="height:400px;overflow-y:scroll;" id="db_item_main3_field">
												<!--{if $db_item_main3}-->
												<!--{foreach $db_item_main3 $field}-->
												<input type="checkbox" name="db_item_main3_field[]" value="{$field['Field']}" {if in_array($field['Field'],$config['db_item_main3_field'])}checked{/if} /> {$field['Field']}  {$field['Comment']}
												<input type="hidden" name="main3_comment[{$field['Field']}]" value="{$field['Comment']}" /><br/>
												<!--{/foreach}-->
												<!--{else}-->
												请选择副表2
												<!--{/if}-->
											</div>
										</td>								
									</tr>
									<tr>
										<td>数据表别名</td>
										<td align="center">主表0别名：a</td>
										<td align="center">副表1别名：b</td>
										<td align="center">副表2别名：c</td>
									</tr>
									<tr>
										<td>筛选条件</td>
										<td><input type="text" class="txt" name="db_item_main_where" value="{if $config['db_item_main_where']}{$config['db_item_main_where']}{/if}" placeholder="示例:a.id<100" /></td>
										<td><input type="text" class="txt" name="db_item_main2_where" value="{if $config['db_item_main2_where']}{$config['db_item_main2_where']}{/if}" placeholder="示例:b.id<100" /></td>
										<td><input type="text" class="txt" name="db_item_main3_where" value="{if $config['db_item_main3_where']}{$config['db_item_main3_where']}{/if}" placeholder="示例:c.id<100" /></td>
									</tr>
									<tr>
										<td>关联条件</td>
										<td></td>
										<td>副表1与主表关联条件：<br><input type="text" class="txt" name="db_item_main2_inner" value="{if $config['db_item_main2_inner']}{$config['db_item_main2_inner']}{/if}" placeholder="示例:a.id = b.iid" /></td>
										<td>副表2与主表/副表1关联条件：<br><input type="text" class="txt" name="db_item_main3_inner" value="{if $config['db_item_main3_inner']}{$config['db_item_main3_inner']}{/if}" placeholder="示例:a.id = c.iid" /></td>
									</tr>
								</table>
							</td>							
						</tr>
						<tr>
						  <td class="tdL"><br>自定义内容数据表SQL（供步骤5.导入内容使用）<br/>（与“内容数据表”二选一）</td>
						  <td class="tdR">此项填写则上述“内容数据表”选项配置将失效<br/><input type="text" name="db_item_sql" class="txt" style="width:90%" value="{if $config['db_item_sql']}{$config['db_item_sql']}{/if}"></td>
						</tr>
						<tr>
						  <td class="tdL">调试/预览<br/>(只取代表性的一个数据)</td>
						  <td class="tdR"><div id="preview" style="display:none;width:80%;max-width:80%;overflow-x:scroll;"></div></td>						  
						</tr>
						<tr>
						  <td class="tdL">&nbsp;</td>
						  <td class="tdR">
							<input type="hidden" id="action" name="action" value="config"/>
							<input type="hidden" name="tmptable" value=""/>	
							<input type="button" onclick="dbm_action_config('config')" value="2.1{$P8LANG['config']}" class="submit_btn"/><span style="font-weight:700;font-size:14px;"> --> </span>
							<input type="button" onclick="dbm_action_config('build_sql')" value="2.2测试构建内容SQL" class="submit_btn"/>
						  </td>
					  </tr>
					</table>
				</td></tr>
			</table>
		</div>
	</div>
</form>
<div class="mainbox mainborder">
	<div class="section">
		<table class="columntable formtable">			
			<tr>
				<td class="title">应用场景说明</td>
			</tr>
			<tr>
				<td>
					1、当需要将某个使用MySQL数据库的系统数据采集入库到本系统中时使用。<br>
					2、如遇到提示“严正警告！！！您的攻击行为已经被记录在案，我们已保留证据！”，请在全局设置中暂时关闭“开启攻击防护模式”再操作。
					<a style="color:blue;" href="{$core.admin_controller}/core-global_config" target="_blank">后台全局设置</a><br/>
					3、国微系统发布信息的最小字段为：内容栏目（cid）、标题（title）、内容（content）、分站别名（分站才需要）（site），
					选择性通用字段请参考：<a style="color:blue;" href="{$core.admin_controller}/core/dbm-struct?name=p8_cms_item" target="_blank">通用字段</a>
					自字义字段以“文章模型”为例，请参考模型设置：<a style="color:blue;" href="{$core.admin_controller}/cms/model-list_field?model=article" target="_blank">文章模型自定义字段</a><br/>
					4、假设要构建的SQL为：<br>SELECT a.id,a.title,a.user_id,a.icon,a.keyword,a.content,a.source,a.views,a.post_at,a.created_at ,b.web_id,b.category_id FROM cms_articles AS a INNER JOIN cms_web_article AS b ON a.id=b.article_id
					<br>则参考配置如下：<br/><div style="margin:0 auto;text-align:center;"><img src="{$SKIN}/core/spider/spider_table.jpg"></div>
				</td>
			</tr>							
		</table>
	</div>
</div>
<script type="text/javascript">
$('.mysqlboxmenu li').removeClass('active');
$(".mysqlboxmenu li:nth-child(5)").addClass("active");
var db_item_main_json = {$db_item_main_json};
var db_item_main2_json = {$db_item_main2_json};
var db_item_main3_json = {$db_item_main3_json};

function dbm_action_config(action){
	$('#request input[name=action]').val(action);
	$.ajax({
		url: '$this_url',
		data: $('#request').serialize(),
		type:'POST',
		dataType: 'text',
		cache: false,
		beforeSend: function(){
			ajaxing({'text':'操作中...'});
		},
		success: function(json){
			ajaxing({action: 'hide'});			
			if(action != 'config'){
				$('#preview').show();
				$('#preview').html(json);
				p8_window.alert('{$P8LANG['done_preview']}');
			}else{
				$('#preview').hide();
				$('#preview').html('');
				p8_window.alert(json);
			}
		}
	});
}

function get_table_struct(table,selectid){
	if(!table){
		p8_window.alert('请选择数据表');
	}else{		
		$('#request input[name=tmptable]').val(table);
		$('#request input[name=action]').val('get_table_struct');	
		$.ajax({
			url: '$this_url',
			data: $('#request').serialize(),
			type:'POST',
			dataType: 'json',
			cache: false,
			beforeSend: function(){
				ajaxing({'text':'获取中...'});
			},
			success: function(json){
				var chk = '';
				var arr = db_item_main_json;
				if(selectid == 'db_item_main2_field') arr = db_item_main2_json;
				if(selectid == 'db_item_main3_field') arr = db_item_main3_json;
				ajaxing({action: 'hide'});				
				$('#'+selectid).html('');
				console.log(selectid,arr);
				for(var i in json){
					chk = '';
					if(arr.indexOf(json[i].Field) >= 0) chk = 'checked';					
					$('<input type="checkbox" name='+selectid+'[] value="'+ json[i].Field +'" '+chk+' /> '+ json[i].Field +' '+ json[i].Comment +'<br/>').appendTo($('#'+selectid));
				}
				p8_window.alert('{$P8LANG['done']}');			
				
			}
		});
	}
}
</script>
<!--{template $core footer admin}-->
<!--{/php168}-->
