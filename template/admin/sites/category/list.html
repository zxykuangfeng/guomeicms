<!--{php168}-->
<!--{template $this_system header admin}-->

<script type="text/javascript" src="{$RESOURCE}/js/autocomplete.js"></script>
<script type="text/javascript" src="{$RESOURCE}/js/recursive_selector.js"></script>
<link rel="stylesheet" href="{$SKIN}/cms/category_selector.css" type="text/css" />
<style type="text/css">
body, html{overflow:inherit;}
.field{
	border: 1px solid #CCCCCC;
	padding: 10px;
	margin: 1em;
}

.field legend{
	font-size:14px;
	border: 1px solid #CCCCCC;
	padding: 2px 4px;
	margin-bottom:0;
}
</style>
<div class="section">
	<table class="formtable" width="100%">
		<tr>
			<td class="headerbtn_list">
				<ul class="sites-top-menu">
					<li><a href="{$this_system.admin_controller}/item-list" target="main"><i class="fa fa fa-list-ul"></i>内容管理</a></li>
					<li><a href="{$this_system.admin_controller}/category-list" target="main"><i class="fa fa-cog"></i>栏目管理</a></li>
					<li><a href="{$this_system.admin_controller}/category-recycle_list" target="main"><i class="fa fa-line-chart"></i>信息回收站</a></li>
					<li><a href="{$this_system.admin_controller}/farm-menu_list"><i class="fa fa-cog"></i>菜单管理</a></li>
					<li><a href="javascript:void(0);" onclick="cache_base_sites()"><i class="fa fa-refresh"></i>更新本站缓存 </a></li>
					<li><a href="javascript:;" onclick="list_to_html('{$this_system->SITE}')"><i class="fa fa-refresh"></i>静态本站所有数据</a></li>
					<li style="float:right;background:#367fc1;border-radius:4px;height:30px;line-height:30px;"><a href="{if empty($site_info['ipordomain'])}{$core->CONFIG['url']}/s.php/{$site}{else}{$site_info['domain']}{/if}" style="color:#fff;border:none;box-shadow:none;height:30px;line-height:30px;" target="_blank"><i class="fa fa-map-marker"></i>当前站点：{$site_info['sitename']}</a></li>
				</ul>
			</td>
		</tr>
	</table>
</div>
<div class="mainbox mainborder">
	<div class="section">
		<form action="$this_url?site={$this_system->SITE}" method="post" id="form">
			<table width="100%" border="0" class="mainbox">
				<tbody>
					<tr>
						<td>
							<ul class="sites-down-menu">
								<li class="btn-color1"><a href="{$this_system.admin_controller}/category-add" target="_blank"><i class="icon icon-ico44"></i>添加栏目</a></li>
								<li class="btn-color3"><a href="javascript:;" onclick="clone_cate(checked_values('id[]', $('#form')))"><i class="icon icon-ico48"></i>复制栏目</a></li>
								<li class="btn-color2"><a href="javascript:;" onclick="update_category(checked_values('id[]', $('#form')))"><i class="icon icon-ico45"></i>编辑栏目</a></li>
								<li class="btn-color10"><a href="javascript:;" onclick="recycle_category(checked_values('id[]', $('#form')))"><i class="icon icon-ico46"></i>删除栏目</a></li>
								<li class="btn-color11"><a href="javascript:;" onclick="merge(checked_values('id[]', $('#form')))"><i class="icon icon-ico49"></i>合并栏目</a></li>
								<li class="btn-color12"><a href="javascript:;" onclick="label_category(checked_values('id[]', $('#form')))"><i class="icon icon-ico45"></i>栏目可视化</a></li>
								<li class="btn-color13"><a href="javascript:;" onclick="label_view(checked_values('id[]', $('#form')))"><i class="icon icon-ico45"></i>内容可视化</a></li>
								<li class="btn-color16"><a href="javascript:;" onclick="view_category(checked_values('id[]', $('#form')))"><i class="icon icon-ico51"></i>查看动态</a></li>
								<!--li class="btn-color17"><a href="javascript:;" onclick="view_category_html(checked_values('id[]', $('#form')))"><i class="icon icon-ico51"></i>查看静态</a></li-->
								<li class="btn-color9 dropdown">
									<a class="dropdown-toggle" href="{$this_system.admin_controller}/item-add" target="_blank"><i class="icon icon-ico9"></i>发布内容</a>
									<ul class="dropdown-menu">
										<!--{php $count=1;}-->
										<!--{foreach $this_system->models $model $value}-->
										<!--{if $value['enabled']}-->
										<li class="btn-color{$count}"><a href="{$this_system.admin_controller}/item-add?model={$model}" target="_blank"><i class="icon icon-ico55"></i>{$value[alias]}</a></li>
										<!--{php $count++;}-->
										<!--{/if}-->
										<!--{/foreach}-->
									</ul>
								</li>
								<li class="course pull-right">
									<ul class="operation-nav">
										<li>
											<a href="{$RESOURCE}/attachment/jiaocheng/zizhanlanmu.pdf" target="_blank" style="color:#c00;"><img src="{$RESOURCE}/skin/admin/help_icon.gif" class="helpicon"> 栏目教程>></a>
											<ul class="dropdown-menu" style="left:auto;right:0;">
												<li class="btn-color1"><a href="{$RESOURCE}/attachment/jiaocheng/zizhanjingtai.pdf" target="_blank" ><i class="icon icon-ico55"></i>静态所有数据</a></li>
												<li class="btn-color2"><a href="{$RESOURCE}/attachment/jiaocheng/xiugaizizhanlanmu.pdf" target="_blank" class="ys2"><i class="icon icon-ico55"></i>修改和删除栏目</a></li>
												<li class="btn-color3"><a href="{$RESOURCE}/attachment/jiaocheng/xinzengzizhanlanmu.pdf" target="_blank" ><i class="icon icon-ico55"></i>新增文章栏目 </a></li>
												<li class="btn-color4"><a href="{$RESOURCE}/attachment/jiaocheng/xinzendanwangyezizhan.pdf" target="_blank" class="ys2"><i class="icon icon-ico55"></i>新增单网页栏目</a></li>
												<li class="btn-color5"><a href="{$RESOURCE}/attachment/jiaocheng/xiugaizizhanlanmuyangshi.pdf" target="_blank" ><i class="icon icon-ico55"></i>栏目显示样式</a></li>
												<li class="btn-color6"><a href="{$RESOURCE}/attachment/jiaocheng/neiwangfangwenzizhanlanmu.pdf" target="_blank" class="ys2"><i class="icon icon-ico55"></i>栏目仅限内网访问设置</a></li>
												<li class="btn-color7"><a href="{$RESOURCE}/attachment/jiaocheng/mimafangwenzizhanlanmu.pdf" target="_blank" ><i class="icon icon-ico55"></i>栏目需密码访问的设置</a></li>
												<li class="btn-color8"><a href="{$RESOURCE}/attachment/jiaocheng/wushanlanmuzizhan.pdf" target="_blank" class="ys2"><i class="icon icon-ico55"></i>误删栏目恢复</a></li>
												<li class="btn-color9"><a href="{$RESOURCE}/attachment/jiaocheng/jintaikaiqizizhanlanmu.pdf" target="_blank" ><i class="icon icon-ico55"></i>栏目静态化开启和关闭</a></li>
												<li class="btn-color10"><a href="{$RESOURCE}/attachment/jiaocheng/lanmuhecaidanzizhan.pdf" target="_blank" class="ys2"><i class="icon icon-ico55"></i>栏目和菜单关系</a></li>
												<li class="btn-color11"><a href="{$RESOURCE}/attachment/jiaocheng/wuxiaoguozizhanlanmu.pdf" target="_blank" ><i class="icon icon-ico55"></i>栏目没有效果的处理方法</a></li>
												<li class="btn-color12"><a href="{$RESOURCE}/attachment/jiaocheng/zizhanlanmu.pdf" target="_blank" class="ys2"><i class="icon icon-ico55"></i>完整栏目教程</a></li>
											</ul>
										</li>
									</ul>
								</li>
							</ul>
						</td>
					</tr>
				</tbody>
			</table>
			<table width="100%" cellspacing="0" cellpadding="0" class="zq_list hover_table" align="center">
				<tr class="title fix_head list_top">
					<td width="1%" class="list_top title">&nbsp;</td>
					<td width="3%" class=" list_top title"><input type="checkbox" onclick="check_all(this, 'id[]', $('#form'));" /></td>
					<td width="5%" class="list_top title">ID</td>
					<td width="10%" class="list_top title" title="0" style="text-align:left" onclick="if(this.title == 1){this.title=0;hide_all();$(this).find('span img').attr('src', '{$SKIN}/show.gif');}else{this.title=1;show_all();$(this).find('span img').attr('src', '{$SKIN}/hide.gif');}" style="cursor: pointer;"><span><img src="{$SKIN}/show.gif" /></span>（可展开）栏目名称</td>
					<td width="5%" class="list_top title">{$P8LANG['sites_category_model']}</td>
					<td width="5%" class="list_top title">{$P8LANG['sites_category_type']}</td>
					<td width="6%" class="list_top title">{$P8LANG['sites_category_sitename']}</td>
					<td width="3%" class="list_top title">{$P8LANG['htmlize']}</td>
					<td width="3%" class="list_top title">{$P8LANG['sites_category_count']}</td>
					<td width="5%" class="list_top title">{$P8LANG['sites_category_item_count']}</td>
					<td width="5%" class="list_top title">{$P8LANG['views']}</td>
					<td width="5%" class="list_top title">{$P8LANG['sites_category_order']}</td>
					<td width="*" class="list_top title">{$P8LANG['operation']}</td>
				</tr>
				<tbody id="__"></tbody>
			</table>
			<table width="100%" border="0" cellpadding="0" cellspacing="0" class="foot_btn">
				<tr>
					<td>
						<ul class="column-operation celarfix">
							<li><input type="button" value="{$P8LANG['update_cache']}" onclick="_submit('cache')" class="edit_btn" /><li>
							<li><input type="submit" value="{$P8LANG['sites_category_update_order']}" class="edit_btn" /><li>
							<li><input type="button" value="{$P8LANG['sites_category_fix']}" onclick="_submit('fix')" class="edit_btn" /><li>
							<li class="dropdown">
								<a class="edit_btn">静态网站</a>
								<ul class="dropdown-menu">
									<li><input type="button" value="{$P8LANG['sites_html_content']}" onclick="view_to_html()" class="edit_btn" /></li>
									<li><input type="button" value="{$P8LANG['sites_html_category']}" onclick="list_only_html()" class="edit_btn" /></li>
									<li><!--{if empty($item_config['menu_sites_html_all'])}-->
									<input type="button" value="{$P8LANG['sites_html_all']}" onclick="list_to_html()" class="edit_btn" />
									<!--{/if}--></li>
								</ul>
							</li>
							<li class="dropdown">
								<a class="edit_btn">开启网站静态</a>
								<ul class="dropdown-menu">
									<li>
										<!--{if empty($item_config['menu_sites_set_htmlize'])}-->
										<input type="button" value="{$P8LANG['sites_set_htmlize']}" onclick="_submit('htmlize')" class="edit_btn" />
										<!--{/if}-->
									</li>
									<li>
										<!--{if empty($item_config['menu_sites_conten_htmlize'])}-->
										<input type="button" value="{$P8LANG['sites_conten_htmlize']}" onclick="_submit('content_htmlize')" class="edit_btn" />
										<!--{/if}-->
									</li>
								</ul>
							</li>
							<li class="dropdown">
								<a class="edit_btn">关闭网站静态</a>
								<ul class="dropdown-menu">
									<li>
										<!--{if empty($item_config['menu_sites_set_unhtmlize'])}-->
										<input type="button" value="{$P8LANG['sites_set_unhtmlize']}" onclick="_submit('unhtmlize')" class="edit_btn" />
										<!--{/if}-->
									</li>
									<li>
										<!--{if empty($item_config['menu_sites_conten_unhtmlize'])}-->
										<input type="button" value="{$P8LANG['sites_conten_unhtmlize']}" onclick="_submit('content_unhtmlize')" class="edit_btn" />         
										<!--{/if}-->
									</li>
								</ul>
							</li>
							<li><input type="button" value="{$P8LANG['recycle']}" onclick="recycle_category(checked_values('id[]', $('#form')))" class="edit_btn" /></li>
							<li class="dropdown">
								<a class="edit_btn">{$P8LANG['sites_content_setlan']}</a>
								<ul class="dropdown-menu">
									<input type="button" value="{$P8LANG['sites_content_setlan']}" onclick="content_setlan(checked_values('id[]', $('#form')),'content_lan')" class="edit_btn" />
									<input type="button" value="{$P8LANG['sites_content_setlan_limit']}" onclick="content_setlan(checked_values('id[]', $('#form')),'content_lan_limit')" class="edit_btn" />
									<input type="button" value="{$P8LANG['sites_content_setlan_delete']}" onclick="_delete_html()" class="edit_btn" />
								</ul>
							</li>
							<li><input type="button" value="{$P8LANG['sites_content_setunlan']}" onclick="content_setlan(checked_values('id[]', $('#form')),'content_unlan')" class="edit_btn" /></li>
							<li><input type="hidden" name="action" value="" /></li>
						</ul>
					</td>
				</tr>
			</table>
		</form>
	</div>
</div>
<div id="status">
<fieldset class="field" id="shower">
	<legend style="font-size:14px;">列表页</legend>
	<iframe name="shower" width="100%" height="120" marginheight="0" marginheight="0" frameborder="0"></iframe>
</fieldset>

<fieldset class="field" id="shower2">
	<legend style="font-size:14px;">内容页</legend>
	<iframe name="shower2" width="100%" height="120" marginheight="0" marginheight="0" frameborder="0"></iframe>
</fieldset>
</div>

<form id="list_to_html" action="{$this_system.admin_controller}/item-list_to_html" method="post" target="shower">
</form>
<form id="view_to_html" action="{$this_system.admin_controller}/item-view_to_html" method="post" target="shower2">
</form>
<form id="list_only_html" action="{$this_system.admin_controller}/item-list_to_html" method="post" target="shower">
</form>

<iframe name="poster" src="about:blank" style="display: none;"></iframe>

<script type="text/javascript">
var CATEGORY_JSON = $json[json];
var CATEGORY_PATH = $json[path];
var MODEL_JSON = $json[models];
var CATEGORY_SUMS = $json[sums];
var CATEGORY_CATS = $statistic_cats;
var CATEGOYR_HTML = [];
var LAN_DATE = $item_config[lan_date];

function _delete_html(){
	p8_window.confirm('{$P8LANG['confirm_to_do']}', function (r) {
		if(r){			
			$.ajax({
				url: '{$this_system.admin_controller}/item-delete_html',
				type: 'GET',
				dataType: 'json',
				data: ajax_parameters({site_flag:'{$this_system->SITE}'}),
				cache: false,
				beforeSend: function(){
					ajaxing({'text':'{$P8LANG[running]}'});
				},
				success: function(json){
					ajaxing({action: 'hide'});
					p8_window.alert('{$P8LANG['done']}');
				}
			});
		}
	});
	
	return false;
}
function _submit(action){
	//if(!confirm('$P8LANG[confirm_to_do]')) return;
	p8_window.confirm('{$P8LANG['confirm_to_do']}', function (r) {
		if(r){
			ajaxing({text:'处理中...'});
			$('#form input[name=action]').val(action);
			$('#form').submit();
		}else{
			return;
		}
	});	
}

function show_all(){
	$('#__ tr').each(function(){
		var tr = $(this).show();
		
		if(tr.attr('sub')){
			tr.attr('title', 1).find('td:eq(3) span').html('<img src="{$SKIN}/hide.gif" />');
		}
	});
}

function hide_all(){
	$('#__ tr').each(function(){
		var tr = $(this);
		
		if(tr.attr('sub')){
			tr.attr('title', 0).find('td:eq(3) span').html('<img src="{$SKIN}/show.gif" />');
		}
		
		if(tr.attr('level') != 1) tr.hide().attr('title', 1);
	});
}

function ___(json, l, p){
	l = l === undefined ? 0 : l;
	p = p === undefined ? 0 : p;
	
	var j = 0, k = count(json);
	for(var i in json){
		if(json[i].htmlize >0) {
			CATEGOYR_HTML.push("h_"+json[i].id);
		}
		var html = '';
		j++;
		var c = '';
		if(l != 0){
			c += str_repeat('│&nbsp;&nbsp;', l - p) + str_repeat('&nbsp;&nbsp;&nbsp;', p);
			if(j == k){
				p++;
				c += '└';
			}else{
				c += '├';
			}
		}
		var sub = json[i].categories ? true : false;
		var static_enable = {$core->CONFIG[static_enable]} ? true : false;
		var path = CATEGORY_PATH[json[i].id].join('_');
		c += (json[i].categories ? '<span style="cursor: pointer;"><img src="{$SKIN}/hide.gif"/></span> ' : '') +
			'<a href="{$this_system.admin_controller}/item-list?model='+ (json[i].categories ? json[i].model : '') +'&cid='+ json[i].id +'" target="_blank">'+ json[i].name +'</a>';
		
		html += 
		'<tr id="category_'+ json[i].id +'" path="path_'+ path +'" title="1"'+ (sub ? ' sub="1"' : '') +' level="'+ (l +1) +'">'+
			'<td>&nbsp;</td>'+
			'<td><input type="checkbox" name="id[]" value="'+ json[i].id +'" onclick="_check(\''+ path +'\', this.checked)" /></td>'+
			'<td>'+ json[i].id +'</td>'+
			'<td class="c_name" model="'+ json[i].model +'" style="text-align:left">'+ c +'</td>'+
			'<td><a href="###" onclick="filter_model(\''+ json[i].model +'\')">'+ (json[i].type==3?'none':MODEL_JSON[json[i].model].alias) +'</a></td>'+
			'<td>'+ (json[i].type == 1 ? '{$P8LANG['sites_category_type_1_s']}' : json[i].type == 2? '{$P8LANG['sites_category_type_2_s']}':json[i].type == 3?'{$P8LANG['sites_category_type_3_s']}':'{$P8LANG['sites_category_type_4_s']}') +'</td>'+
			'<td><a href="{$site_url}" style="color:#165aa1;" target="_blank">{$sitename_alias}</a></td>'+
			'<td align="center" class="enables"><img id="cate_'+json[i].id+'" title="'+json[i].htmlize+'" src="{$SKIN}/'+ (json[i].htmlize == 1 ? 'check_yes.gif' : (json[i].htmlize == 2?'check_2.gif':'check_no.gif')) +'"></td>'+
			'<td align="center"><img id="cates_'+json[i].id+'" title="'+json[i].htmlize+'" src="{$SKIN}/'+ (CATEGORY_CATS.indexOf(json[i].id) != -1 ? 'check_yes.gif' : 'check_no.gif') +'"></td>'+			
			'<td>'+ json[i].item_count +'</td>'+
			'<td align="center">'+ CATEGORY_SUMS[json[i].id] +'</td>'+
			'<td><input type="text" class="txt" name="display_order['+ json[i].id +']" value="'+ json[i].display_order +'" size="4" /></td>'+
			'<td>'+
				'<ul class="operation-nav">'+
					'<li class="dropdown">'+
						'<a class="btn-color41">栏目查看</a>'+
						'<ul class="dropdown-menu">'+
							'<li class="btn-color1"><a href="'+ json[i].url +'" target="_blank" title="静态页访问地址" class="ys1"><i class="icon icon-ico55"></i><span id="category_html_'+json[i].id+'">静态预览</span></a></li> '+
							'<li class="btn-color2"><a href="{$this_system.siteurl}/item-list-category-'+ json[i].id+'" target="_blank" title="主域名动态{$P8LANG['preview']}" class="ys1"><i class="icon icon-ico55"></i>动态预览</a></li> '+
						'</ul>'+
					'</li>'+
					'<li><a class="btn-color42" href="{$this_system.admin_controller}/item-add?model='+ json[i].model +'&cid='+ json[i].id +'&type='+ json[i].type +'" target="_blank" title="发布内容">发布内容</a></li> '+
					'<li><a class="btn-color43" href="$this_router-update?model=&id='+ json[i].id +'" title="{$P8LANG['edit']}" target="_blank">编辑栏目</a> '+
					'<li><a class="btn-color10" href="$this_router-add?parent='+ json[i].id +'&model='+json[i].model+'" title="{$P8LANG['add_sites_sub_category']}" target="_blank">加子栏目</a></li> '+
					'<li><a class="btn-color11" href="{$this_system.siteurl}/item-list-category-'+ json[i].id +'?edit_label=1" target="_blank" title="{$P8LANG['label']}">列表标签</a></li> '+
					'<li><a class="btn-color12" href="{$this_system.siteurl}/item-view-id-?edit_label=1" target="_blank" onclick="edit_view_label('+json[i].type+','+json[i].id+');return(false)" title="{$P8LANG['sites_category_view_page_label']}"><span id="edit_view_label_'+json[i].id+'">内容标签</span></a></li> '+
					'<li><a class="btn-color13" href="###" title="{$P8LANG['sites_category_merge']}" onclick="merge('+ json[i].id +');">合并</a></li> '+
					'<li><a class="btn-color16" href="###" title="{$P8LANG['sites_category_clone']}" onclick="clone_cate('+ json[i].id +');">克隆</a></li> '+
					'<li><a class="btn-color18" href="{$this_system.admin_controller}/farm-menu_list"target="_blank">设置菜单</a></li> '+
					'<li><a class="btn-color44" id="recycle_'+ json[i].id +'" href="javascript:;" onclick="return recycle_category([this.id]);" title="{$P8LANG['recycle']}">删除</a></li> '+
					'<li class="dropdown">'+
						'<a class="btn-color41">>></a>'+
						'<ul class="dropdown-menu">'+
							'<li class="btn-color1"><a href="{$core.admin_controller}/core/member-set_member_acl?system=sites" target="_blank" title="栏目权限" class="ys1"><i class="icon icon-ico55"></i><span>栏目权限</span></a></li> '+
						'</ul>'+
					'</li>'+
				'</ul>'+
			'</td>'+
		'</tr>';
		
		var tr = $(html);
		$('#__').append(tr);
		if(sub){
			___(json[i].categories, l +1, p);
			_toggle(
				$(tr).find('td:eq(3) span').
				bind('click', function(){_toggle($(this)); return false;})
			);
		}
	}
}

___(CATEGORY_JSON);

function _toggle(span){
	var id = $(span).parent().parent().attr('id').replace(/[^0-9]/g, '');
	var path = CATEGORY_PATH[id].join('_');
	
	var on = $('#category_'+ id).attr('title') == 0;
	
	var keep_close = [];
	$('tr[path^=path_'+ path +'_]').each(function(){
		if(on){
			
			if($(this).show().attr('title') == 1 && $(this).attr('sub')){
				keep_close.push(this.id.replace(/[^0-9]/g, ''));
				$(this).attr('title', 0);
			}else{
				$(this).attr('title', 1);
			}
			
		}else{
			
			if($(this).hide().attr('title') == 0 && $(this).attr('sub')){
				//keep close
				$(this).attr('title', 1);
			}else{
				$(this).attr('title', 0);
			}
			
		}
	});
	
	if(on){
		$(span).parent().parent().attr('title', 1);
		$(span).html('<img src="{$SKIN}/hide.gif" />');
	}else{
		$(span).parent().parent().attr('title', 0);
		$(span).html('<img src="{$SKIN}/show.gif" />');
	}
	
	for(var i = 0; i < keep_close.length; i++){
		$('tr[path^=path_'+ CATEGORY_PATH[keep_close[i]].join('_') +'_]').hide().find('span');
	}
	return false;
}

function find_category(json,find_id){
	var category_name = '';
	
	for(var i in json){
		if(json[i].id == find_id){
			category_name = json[i].name;
			return category_name;
		}else{
			if(json[i].categories){
				category_name = find_category(json[i].categories,find_id);
				if(category_name) return category_name;
			}
		}
	}
}
	
function recycle_category(array){
	var id = [];
	$.each(array, function(k, v){
		id.push(v.replace(/[^0-9]/g, ''));
	});
	if(!id.length) {
		p8_window.alert('{$P8LANG[sites_category_need_select]}');
		return;
	}
	var category_name = '';
	var confirm_info = '{$P8LANG['sites_category_confirm_to_recycle']}';
	if(id.length == 1){
		category_name = find_category(CATEGORY_JSON,id[0]);
		confirm_info = '{$P8LANG['sites_category_confirm_to_recycle']}<br><span style="color:blue;text-align:centet;">'+category_name+'(ID：'+id[0]+')</span>';
	}	
	p8_window.confirm(confirm_info, function (r) {
		if(r){			
			$.ajax({
				url: '$this_router-recycle',
				type: 'POST',
				dataType: 'json',
				data: ajax_parameters({model: '$MODEL', id: id}),
				cache: false,
				beforeSend: function(){
					ajaxing({});
				},
				success: function(json){
					
					ajaxing({action: 'hide'});
					
					for(var i in json){
						$('#recycle_'+ json[i]).parent().parent().remove();
					}
				}
			});
		}
	});
	
	return false;
}
function label_category(ids){
	if(Array.isArray(ids)){
		if(ids.length<1) {
			p8_window.alert('{$P8LANG[sites_category_need_select]}');
			return;
		}
	}
	for(var i in ids){
		openUrl('{$this_system.siteurl}/item-list-category-'+ids[i]+'?edit_label=1');
	}
}
function label_view(ids){
	if(Array.isArray(ids)){
		if(ids.length<1) {
			p8_window.alert('{$P8LANG[sites_category_need_select]}');
			return;
		}
	}
	for(var i in ids){
		$('#edit_view_label_'+ids[i]).click();
	}
}
function view_category_html(ids){
	if(Array.isArray(ids)){
		if(ids.length<1) {
			p8_window.alert('{$P8LANG[sites_category_need_select]}');
			return;
		}
	}
	for(var i in ids){
		setTimeout($('#category_html_'+ids[i]).click(),500*i);
	}
}
function view_category(ids){
	if(Array.isArray(ids)){
		if(ids.length<1) {
			p8_window.alert('{$P8LANG[sites_category_need_select]}');
			return;
		}
	}
	for(var i in ids){
		openUrl("{$this_system.siteurl}/item-list-category-"+ids[i]);
	}
}
function content_setlan(cid,action){
	var id = [];
	$.each(cid, function(k, v){
		id.push(v.replace(/[^0-9]/g, ''));
	});
	if(!id.length) {
		p8_window.alert('{$P8LANG[sites_category_need_select]}');
		return false;
	}
	if(action == 'content_lan_limit' && LAN_DATE == 0){
		p8_window.alert('超年限时间节点必须设置 <a href="{$this_router}/../item-set_lan" style="color:blue;" target="_blank">去设置</a>');
		return false;
	}
	p8_window.confirm('{$P8LANG['confirm_to_do']}', function (r) {
		if(r){			
			$.ajax({
				url: '$this_url',
				type: 'POST',
				dataType: 'json',
				data: ajax_parameters({action: action, cid: id}),
				cache: false,
				beforeSend: function(){
					ajaxing({});
				},
				success: function(json){
					
					ajaxing({action: 'hide'});
					$('#form input[name=action]').val('fix');
					$('#form').submit();
				}
			});
		}
	});
	
	return false;
}

function filter_model(m){
	$('#__ td.c_name[model='+ m +']').attr('style', '');
	$('#__ td.c_name[model!='+ m +']').attr('style', 'filter: alpha(opacity=40); opacity: 0.4;');
}

$('form input[name^=display_order]').change(function(){
	this.value = this.value.replace(/[^0-9]/g, '') || 0;
	if(this.value > 9999) this.value = 9999;
	if(this.value < 0) this.value = 0;
	
	$('#form').append('<input type="hidden" name="_display_order['+ this.name.replace(/[^0-9]/g, '') +']" value="'+ this.value +'" />');
	$(this).css({border: '1px solid #ff0000'});
});

function get_category_by_id(id){
	var path = clone(CATEGORY_PATH[id]);
	var root = path.shift();
	var search = CATEGORY_JSON[root];
	
	if(path.length == 0){
		return search;
	}
	for(var i in path){
		search = search.categories[path[i]];
	}
	return search;
}

function edit_view_label(b,id){
	if(b == '1'){
		p8_window.alert('{$P8LANG['sites_category_type_1_no_item_label']}');
		return;
	}
	
	$.ajax({
		url: '$this_router-edit_view_label',
		type: 'POST',
		dataType: 'html',
		data: 'cid='+id,
		cache: false,
		beforeSend: function(){
			ajaxing({});
		},
		success: function(json){
			ajaxing({action: 'hide'});
			if(json=='-1'){p8_window.alert('{$P8LANG['sites_category_no_item_yet']}');return;}
			openUrl("{$this_system.siteurl}/item-view-id-"+json+"?edit_label=1&postfix=");
		}
	});
}

function _check(path, checked){
	$('#form tr[path^=path_'+ path +'_] input[name="id[]"]').prop('checked', checked);
}

function list_only_html(){
	if(CATEGOYR_HTML.length<1){
		p8_window.alert('{$P8LANG[sites_category_htmlize]}');
		return;
	}
	$('#list_only_html').empty();
	var ids = checked_values('id[]', $('#form'));
	if(ids.length<1) {
		p8_window.alert('{$P8LANG[sites_category_need_select]}');
		return;
	}
	var pages = 0;
	var items = -1;
	var htmlize_index = -1;
	$('#list_only_html').append($('<input type="hidden" name="pages" value="'+ pages +'" />'));
	for(var i = 0; i < ids.length; i++){
		$('#list_only_html').append($('<input type="hidden" name="cids[]" value="'+ ids[i] +'" />'));
		if($.inArray("h_"+ids[i],CATEGOYR_HTML) >=0){
			htmlize_index = 1;
		}
	}
	if(htmlize_index == 1){
		$('#list_only_html').submit();
	}else{
		p8_window.alert('{$P8LANG[sites_category_htmlize]}');
		return;
	}
	
	html_dialog.show();	
}

function list_to_html(){
	if(CATEGOYR_HTML.length<1){
		p8_window.alert('{$P8LANG[sites_category_htmlize]}');
		return;
	}
	$('#list_to_html').empty();
	$('#view_to_html').empty();
	
	var ids = checked_values('id[]', $('#form'));
	if(ids.length<1) {
		check_all(true, 'id[]');
		ids = checked_values('id[]', $('#form'));
	}
	
	var pages = 0;
	var items = -1;
	var htmlize_index = -1;
	$('#list_to_html').append($('<input type="hidden" name="pages" value="'+ pages +'" />'));
	for(var i = 0; i < ids.length; i++){
		$('#list_to_html').append($('<input type="hidden" name="cids[]" value="'+ ids[i] +'" />'));
		if($.inArray("h_"+ids[i],CATEGOYR_HTML) >=0){
			htmlize_index = 1;
		}
	}	
	if(htmlize_index == 1){
		$('#list_to_html').submit();		
	}else{
		p8_window.alert('{$P8LANG[sites_category_htmlize]}');		
		return;
	}
	html_dialog.show();	
	$('#view_to_html').append($('<input type="hidden" name="items" value="'+ items +'" />'));
	for(var i = 0; i < ids.length; i++){
		$('#view_to_html').append($('<input type="hidden" name="cids[]" value="'+ ids[i] +'" />'));
	}
	
	$('#view_to_html').submit();	
	$.ajax({
		   url:'{$this_system.admin_controller}-index_to_html',
		   type: 'post',
		   dataType: 'json',
		   data: ajax_parameters({site:'{$this_system->SITE}'}),
		   cache: false,
		   success: function(msg){
			   if(msg==-1) p8_window.alert('此站没有绑定域名，不可静态');
		   }
	});

}

var merge_dialog = new P8_Dialog({
	title_text: '{$P8LANG['sites_category_merge']}',
	button: true,
	width: 700,
	height: 500,
	show: function(){
		cs.init();
	}
});

var cs = new Recursive_Selector({
	json: CATEGORY_JSON,
	path: CATEGORY_PATH,
	input: $('#move_cid'),
	dialog: merge_dialog,
	sub_property: 'categories',
	item_callback: function(cat, item){
		if(cat.type == 1)
			item.find('span').addClass('frame_category');
		
		if(cat.categories)
			item.addClass('sub_category');
	},
	change: function(select){
		var cat = this.get_by_id(select.data('value'));
	}
});

function merge(id){
	merge_dialog.show();
	
	merge_dialog.ok(function(){
		$.ajax({
			url: '$this_router-merge',
			type: 'post',
			cache: false,
			data: {id: id, to_id: cs.get_value()},
			beforeSend: function(){
				ajaxing({});
			},
			success: function(s){
				ajaxing({action: 'hide'});
				
				merge_dialog.close();
			}
		});
		return false;
	});
}
var clone_dialog = new P8_Dialog({
	title_text: '{$P8LANG['sites_category_clone']} - {$P8LANG['sites_category_clone_to']}',
	button: true,
	width: 700,
	height: 500,
	show: function(){
		cs2.init();
	}
});
var cs2 = new Recursive_Selector({
	json: CATEGORY_JSON,
	path: CATEGORY_PATH,
	input: $('#move_cid'),
	dialog: clone_dialog,
	sub_property: 'categories',
	item_callback: function(cat, item){
		if(cat.type == 1)
			item.find('span').addClass('frame_category');
		
		if(cat.categories)
			item.addClass('sub_category');
	},
	change: function(select){
		var cat = this.get_by_id(select.data('value'));
	}
});
function clone_cate(id){
	if(Array.isArray(id)){
		if(id.length<1) {
			p8_window.alert('{$P8LANG[sites_category_need_select]}');
			return;
		}
	}
	clone_dialog.show();
	
	clone_dialog.ok(function(){
		$.ajax({
			url: '$this_router-clone',
			type: 'post',
			cache: false,
			data: {id: id, to_id: cs2.get_value()},
			beforeSend: function(){
				ajaxing({});
			},
			success: function(s){
				ajaxing({action: 'hide'});
				clone_dialog.close();
				p8_window.alert('{$P8LANG['done']}');
				location.reload();
			}
		});
		return false;
	});
}
function update_category(ids){
	if(Array.isArray(ids)){
		if(ids.length<1) {
			p8_window.alert('{$P8LANG[sites_category_need_select]}');
			return;
		}
	}
	for(var i in ids){
		openUrl("$this_router-update?model=&id="+ids[i]);
	}
}
function _find(n, json){
	var ret = [];
	for(var i in json){
		if(json[i].name.indexOf(n) != -1)
			ret.push(json[i].id);
		
		if(json[i].categories){
			ret = ret.concat(_find(n, json[i].categories));
		}
	}
	
	return ret;
}

function view_to_html(){
	if(CATEGOYR_HTML.length<1){
		p8_window.alert('{$P8LANG[sites_category_htmlize]}');
		return;
	}
	$('#view_to_html').empty();
	
	var ids = checked_values('id[]', $('#form'));
	var htmlize_index = -1;
	if(ids.length<1) {
		p8_window.alert('{$P8LANG[sites_category_need_select]}');
		return;
	}	
	for(var i = 0; i < ids.length; i++){
		$('#view_to_html').append($('<input type="hidden" name="cids[]" value="'+ ids[i] +'" />'));
		if($.inArray("h_"+ids[i],CATEGOYR_HTML) >=0){
			htmlize_index = 1;
		}
	}	
	if(htmlize_index == 1){
		$('#view_to_html').submit();
	}else{
		p8_window.alert('{$P8LANG[sites_category_htmlize]}');
		return;
	}
	html_dialog.show();
}
var auto = new P8_Autocomplete({
	input: $('#srh'),
	className: 'autocomplete',
	trigger: function(){
		var find = _find(this.keyword, CATEGORY_JSON);
		
		if(!find.length) return;
		//p8_window.alert(find);
		var json = [];
		var parents = '';
		for(var i = 0; i < find.length; i++){
			var parents = '';
			for(var j in CATEGORY_PATH[find[i]]){
				parents += get_category_by_id(CATEGORY_PATH[find[i]][j]).name +' &gt; ';
			}
			
			var cat = get_category_by_id(find[i]);
			json.push({text: parents, value: cat.id});
		}
		
		this.deploy(json);
	},
	callback: function(li){
		p8_window.alert(li.data('value'));
		
		return false;
	}
});

var html_dialog = new P8_Dialog({
	width: 700,
	height: 500,
	overlay: false,
	cancel: function(){
		this.content.find('iframe').attr('src', 'about:blank');
	}
});
html_dialog.content.append($('#status'));
$('.enables img').click(function(){
	var enabled = this.title;
	var htmlize = 0;
	var verified = '$verified';
	if(enabled == 2) htmlize = 20;
	if(enabled == 20) htmlize = 2;
	if(enabled == 0) htmlize = 1;	
	$.ajax({
		url: '$this_router-htmlize',
		type: 'post',
		dataType: 'json',
		cache: false,
		data: {id: this.id.replace(/[^0-9]/g, ''), htmlize: htmlize,verified:verified?1:0},
		beforeSend: function(){
			ajaxing({});
		},
		success: function(json){
			ajaxing({action: 'hide'});
			for(var i in json){
				if(enabled == 1){
					$('#cate_'+ json[i]).attr('src', '{$SKIN}/check_no.gif').attr('title', 0);				
				}
				if(enabled == 2){
					$('#cate_'+ json[i]).attr('src', '{$SKIN}/check_no.gif').attr('title', 20);				
				}
				if(enabled == 20){
					$('#cate_'+ json[i]).attr('src', '{$SKIN}/check_2.gif').attr('title', 2);				
				}
				if(enabled == 0){
					$('#cate_'+ json[i]).attr('src', '{$SKIN}/check_yes.gif').attr('title', 1);				
				}
			}
			
		}
	});
});
function cache_base_sites(){
	p8_window.confirm('{$P8LANG['confirm_to_do']}', function (r) {
		if(r){
			$.ajax({
				url:'{$this_system.admin_controller}/farm-cache',
				type: 'post',
				dataType: 'html',
				data: {},
				cache: false,
				beforeSend: function(){
					ajaxing({text:'缓存中…'});
				},
				success: function(msg){
					ajaxing({text:'操作成功！',action: 'hide'});
				}
			});
		}else{
			return false;
		}
	});	
}
</script>
<!--{template $this_system footer admin}-->
<!--{/php168}-->